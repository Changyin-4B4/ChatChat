# 卡片文件夹配置说明

本文档介绍卡片文件夹的基本结构和各配置文件的用途。

---

## 1. 文件夹基本结构

### 必需文件/文件夹

```
card/
├── prompts/                      # 存储提示词模板 YAML 文件
├── core_configs.json             # 存储 USER_NAME 等核心配置信息
├── prompts_config.json           # 存储字数要求、世界书配置表
├── variables_config.json         # 存储变量信息
└── variables_keyword.json        # 存储关键字更新/重置表格
```

### 可选文件/文件夹

```
card/
├── information/                  # 存储世界书 TXT 文件（可自定义路径）
└── update&reset/                 # 存储 LLM 更新/重置任务说明 TXT 文件（可自定义路径）
```

### 自动生成文件/文件夹

```
card/
└── data/                         # 存储聊天记录（程序自动创建）
```

---

## 2. 变量配置

 **文件** ：`variables_config.json`

 **用途** ：定义游戏中的变量系统，包括记录变量和阶段自变量。

 **详细说明** ：参见 `variables_config_guide.md`

---

## 3. 世界书提示词组装逻辑与提示词映射表

 **文件** ：`prompts_config.json`

 **用途** ：配置世界书的组装规则和提示词映射关系。

 **详细说明** ：参见 `prompts_config_guide.md`

---

## 4. 基础信息配置

 **文件** ：`core_configs.json`

 **用途** ：存储全局配置信息，如用户名、对话模式、记忆深度、API 配置等。

 **详细说明** ：参见 `core_configs_guide.md`

---

## 5. 提示词模板配置

 **文件夹** ：`prompts/`

 **说明** ：

* 程序已附带一组默认提示词模板
* 支持自定义模板，但需保持格式与已有模板一致
* 提示词仅包含 `system`、`assistant`、`user` 角色
* 程序会根据不同供应商要求自动处理提示词格式（如 Gemini 使用 system instruction）
* 所有提示词模板必须位于 `prompts/` 文件夹下
* 可在 `core_configs.json` 中指定使用的 YAML 文件

 **当前附带模板来源** ：Discord 类脑社区 - haruki（鲸鱼娘与金阁寺），已做微调

---

## 6. 世界书配置

 **文件夹** ：`information/`（可自定义）

 **配置要点** ：

* 确保 TXT 文件路径与 `prompts_config.json` 中的配置一致
* 建议在 TXT 文件中使用 XML 标签，有助于 LLM 分类信息
* 开场信息中，确保内容存放在对应的XML标签下，否则无法正确加载

 **XML 标签自动闭合** ：

* 对于 `complex` 配置，只需在 `base_file` 中添加 XML 开始标签
* 程序会自动在内容结束时添加对应的闭合标签
* 若无开始标签则不会添加闭合标签
* 即使没有共用描述作为 `base_file`，仍建议创建一个空文件用于填写 XML 标签头

 **示例** ：

`base_file.txt`：

```xml
<worldbook>
```

`stage_1.txt`：

```
当前阶段内容
```

 **最终输出** ：

```xml
<worldbook>
当前阶段内容
</worldbook>
```

---

## 7. 基于 LLM 判断的更新/重置任务说明配置

 **文件夹** ：`update&reset/`（可自定义）

 **配置要点** ：

* 确保 TXT 文件路径与 `variables_config.json` 中的配置一致
* 文件格式为包含 `<name>` 和 `<description>` 标签的 TXT 文件

 **详细说明** ：参见 `update_reset_guide.md`

---

## 8. 聊天记录存档

 **文件夹** ：`data/`

 **说明** ：

* 程序会自动生成路径和文件
* 一般情况下无需手动操作
* 支持手动修改存档中的变量数值（作弊功能）
  * 修改变量值时建议同步修改更新标识（`relative_is_upgrade`）
  * 若不修改更新标识，不会影响程序运行，但提示词中会缺少变化提示
  * 仍会按修改后的值组合提示词

 **存档结构** ：

```json
{
  "1": {
    "speaker": "Assistant",
    "layer": 1,
    "variable_snapshot": {
      "pre": { ... },
      "post": { ... }
    },
    ...
  }
}
```

---

## 9. 关键字更新/重置配置

 **文件** ：`variables_keyword.json`

 **用途** ：配置基于关键词的变量更新和重置规则。

 **说明** ：

* 如果完全不使用关键字更新，此文件可以为空 `{}`
* 支持关键词计数模式（`KEYWORD_COUNT`）和关键词出现模式（`KEYWORD_APPEAR`）
* 支持数值浮动效果（通过 `min_value` 和 `max_value`）

 **详细说明** ：参见 `variables_keyword_guide.md`

---

## 配置文件一览

| 文件名                     | 用途                                 | 参考文档                       |
| -------------------------- | ------------------------------------ | ------------------------------ |
| `core_configs.json`      | 核心配置（用户名、对话模式、API 等） | `core_configs_guide.md`      |
| `prompts_config.json`    | 世界书配置和提示词映射               | `prompts_config_guide.md`    |
| `variables_config.json`  | 变量定义和更新规则                   | `variables_config_guide.md`  |
| `variables_keyword.json` | 关键词更新/重置规则                  | `variables_keyword_guide.md` |
| `prompts/*.yaml`         | 提示词模板                           | -                              |
| `information/*.txt`      | 世界书内容文件                       | -                              |
| `update&reset/*.txt`     | LLM 判断任务说明                     | `update_reset_guide.md`      |

---

## 快速开始

### 最小配置

以下是运行程序所需的最小配置：

1. **创建文件夹结构**
   ```
   card/
   ├── prompts/
   └── data/
   ```
2. **创建必需配置文件**
   * `core_configs.json`（至少配置 API 信息）
   * `prompts_config.json`（至少配置字数限制）
   * `variables_config.json`（可以为空数组 `[]`）
   * `variables_keyword.json`（可以为空对象 `{}`）
3. **添加提示词模板**
   * 复制默认的 YAML 模板到 `prompts/` 文件夹

### 完整配置

参考各配置文件的详细指南，根据需求逐步完善：

1. 配置变量系统（`variables_config.json`）
2. 设置世界书和提示词映射（`prompts_config.json`）
3. 添加世界书内容文件（`information/`）
4. 配置 LLM 判断任务（`update&reset/`）
5. 设置关键词规则（`variables_keyword.json`）
6. 调整核心配置（`core_configs.json`）

---

## 注意事项

### 路径规范

* 所有配置文件中的路径均为 **相对路径** （相对于工作目录）
* 示例：`"information/worldbook.txt"` 而非 `"/absolute/path/to/worldbook.txt"`

### 文件编码

* 所有配置文件和文本文件均使用 **UTF-8** 编码

### JSON 格式

* 确保 JSON 文件格式正确（可使用 JSON 验证工具检查）
* 注意逗号、引号、括号的正确使用

---

## 常见问题

### Q: 如何自定义文件夹路径？

A: 在相应的配置文件中修改路径即可，例如在 `prompts_config.json` 中修改世界书文件路径。

### Q: 是否必须使用所有功能？

A: 不是。可以根据需求选择性使用功能，未使用的配置文件可以留空。

### Q: 如何备份存档？

A: 复制整个 `data/` 文件夹即可。程序读取 JSON 文件时会自动恢复状态。

### Q: 提示词模板可以使用其他格式吗？

A: 目前仅支持 YAML 格式，需保持与默认模板一致的结构。

---

## 后记

### 关于文件夹结构

目前仍然推荐以**一整个文件夹作为一张卡片**。这是因为 `data/` 文件夹对于一个卡片文件夹只能有一个，暂时没有更好的解决方案。

如果存储多张卡片，会发现 `prompts/` 文件夹在各个卡片中是重复的，这确实有些冗余。可能在之后的版本中会对结构进行调整，但目前还没有明确的想法。

### 关于 API 配置

项目中已经包含了一份 `allowed_models.json` 文件，列出了目前支持的 API 平台和模型配置，可以直接复制到 `core_configs.json` 中使用。

**注意**：对于一些平台（如硅基流动），并未列出所有可用模型。例如一些 14B 的模型没有包含在列表中，如果有需要可以自行添加。由于个人使用需求有限，只配置了常用的几个模型。

### 关于功能规划

**未来可能添加的功能**：

- 游玩过程中动态切换 prompt 模板
- 游玩过程中动态切换 API 供应商和模型

具体时间待定，取决于实际需求和开发进度。

### 关于 LLM 输出规范

尽管对judger 阶段 API 调用添加了 JSON 输出规范，但有些模型真的很不听话，可能会返回格式不正确的结果。这会导致更新失败，reroll对应部分即可，但如果遇到频繁的格式错误，建议：

- 尝试更换模型
- 调整任务说明的措辞
- 在提示词中强调输出格式要求

### 关于默认配置

默认情况下，所有任务（pre_process、create、post_process）都使用 **DeepSeek V3.2**（`deepseek-reasoner`）。这是经过测试效果较好的配置，而且便宜，但你可以根据需求在 `core_configs.json` 中自由调整。

以及，目前测试下来，只有DS的打字机效果是最好的，其他的都是块状输出，有一种卡顿感，我不知道是因为我的程序写得不够好还是来源本身的问题；
