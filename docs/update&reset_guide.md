# LLM 判断任务配置指南（Update & Reset）

本文件说明如何为基于 LLM 判断的变量更新和重置功能编写任务说明文件（.txt）。

---

## 文件概述

* **文件格式** ：`.txt`（纯文本）
* **编码** ：UTF-8
* **用途** ：定义 LLM 需要执行的判断任务，用于动态更新或重置变量值
* **路径** ：相对于工作目录（如 `update&reset/affection_update.txt`）

---

## 基本结构

每个任务文件必须包含以下 XML 标签：

```xml
<name>
任务名称
</name>

<description>
任务说明内容
</description>
```

### 标签说明

| 标签              | 必填 | 说明                                     |
| ----------------- | ---- | ---------------------------------------- |
| `<name>`        | 是   | 任务名称，用于 LLM 返回结果的键名匹配    |
| `<description>` | 是   | 任务说明，包含判断规则、返回值格式和示例 |

---

## 任务类型

### 1. UPDATE 任务（变量更新）

 **用途** ：根据剧情内容动态调整变量值

 **配置示例** ：

```xml
<name>
好感度
</name>

<description>
说明："分析当前剧情，判断小D对{user}的好感度是否有变化"
返回值："返回一个1位小数，范围为-5.0到5.0"
示例：{
    剧情文本："小D感激地望着{user}，轻声道谢。"；返回值：1.5；小D表现出温柔的感谢，好感度上升。
    剧情文本："小D生气地转过头，不再理{user}。"；返回值：-1.0；小D情绪负面，好感度下降。
    剧情文本："{user}救了小D一命，小D泪眼婆娑地拥抱了他。"；返回值：4.0；情感强烈，好感度显著上升。
    剧情文本："两人只是并肩走了一会儿，没有说话。"；返回值：0.0；情感无明显波动。
    剧情文本："小D冷漠地看了看{user}，转身离去。"；返回值：-5.0；极端负面情绪，好感度降至极点。
}
</description>
```

 **关键要素** ：

1. **说明** ：清晰描述判断目标
2. **返回值** ：明确数值类型和范围（ **重要：必须是浮点数！** ）
3. **示例** ：提供多个典型场景及对应返回值

---

### 2. RESET 任务（变量重置）

 **用途** ：检测特定事件，决定是否重置变量

 **配置示例** ：

```xml
<name>
好感度重置
</name>

<description>
说明："分析当前剧情，是否出现小D死亡或者小D与{user}决裂的剧情。"
返回值："返回0或1，1代表出现了相关剧情，好感度需要重置，0代表没有出现。"
示例：{
    剧情文本："小D在爆炸中失去了生命。"；返回值：1；小D死亡，好感度需要重置。
    剧情文本："小D愤怒地说：'我再也不想见到你！'然后离开。"；返回值：1；发生决裂，好感度重置。
    剧情文本："小D昏迷不醒，但还活着。"；返回值：0；没有死亡或决裂。
    剧情文本："小D只是暂时离开去旅行。"；返回值：0；没有情感终结。
}
</description>
```

 **关键要素** ：

1. **说明** ：明确触发重置的条件
2. **返回值** ：固定为 `0` 或 `1`（ **必须是整数或浮点数！** ）

* `0` / `0.0` → 不重置
* `1` / `1.0` → 触发重置

1. **示例** ：提供清晰的边界案例

---

## 编写指南

### 1. 任务名称（`<name>`）

 **规则** ：

* 简洁明了，不超过 20 个字符
* 与变量名称或功能相关
* 避免特殊字符（除中文、英文、数字外）

 **示例** ：

* ✅ `好感度`
* ✅ `时间变化`
* ✅ `体力消耗`
* ❌ `好感度-update-task`（过长且有特殊符号）

---

### 2. 任务说明（`<description>`）

#### 2.1 说明部分

 **格式** ：

```
说明："[简洁描述判断目标和规则]"
```

 **要点** ：

* 使用引号包裹说明内容
* 清晰定义判断的对象和条件
* 避免模糊表述

 **示例** ：

✅  **好的说明** ：

```
说明："分析当前剧情，判断小D对{user}的好感度是否有变化"
```

❌  **不好的说明** ：

```
说明："看看小D的心情"  // 太模糊
```

---

#### 2.2 返回值部分

 **格式** ：

```
返回值："[数值类型]，范围为[最小值]到[最大值]"
```

 **⚠️ 重要规则** ：

* **UPDATE 任务** ：必须返回 **浮点数** （如 `1.5`、`-3.0`）
* **RESET 任务** ：必须返回 **整数 0 或 1** （或浮点数 `0.0`、`1.0`）
* 明确指定范围，避免 LLM 返回超出预期的值

 **示例** ：

✅  **UPDATE 任务返回值** ：

```
返回值："返回一个1位小数，范围为-5.0到5.0"
```

✅  **RESET 任务返回值** ：

```
返回值:"返回0或1，1代表需要重置，0代表不重置。"
```

❌  **错误示例** ：

```
返回值："返回一个数字"  // 没有指定范围
返回值："返回'增加'或'减少'"  // 不是数值类型
```

---

#### 2.3 示例部分

 **格式** ：

```
示例：{
    剧情文本："[场景描述]"；返回值：[数值]；[解释原因]
    剧情文本："[场景描述]"；返回值：[数值]；[解释原因]
    ...
}
```

 **要点** ：

* **至少提供 3-5 个示例**
* 覆盖典型场景和边界情况
* 包含正面、负面、中性和极端案例
* 每个示例包含：场景 + 返回值 + 原因说明

 **示例** ：

✅  **好的示例集** （UPDATE 任务）：

```
示例：{
    剧情文本："小D感激地望着{user}，轻声道谢。"；返回值：1.5；小D表现出温柔的感谢，好感度上升。
    剧情文本："小D生气地转过头，不再理{user}。"；返回值：-1.0；小D情绪负面，好感度下降。
    剧情文本："{user}救了小D一命，小D泪眼婆娑地拥抱了他。"；返回值：4.0；情感强烈，好感度显著上升。
    剧情文本："两人只是并肩走了一会儿，没有说话。"；返回值：0.0；情感无明显波动。
    剧情文本："小D冷漠地看了看{user}，转身离去。"；返回值：-5.0；极端负面情绪，好感度降至极点。
}
```

✅  **好的示例集** （RESET 任务）：

```
示例：{
    剧情文本："小D在爆炸中失去了生命。"；返回值：1；小D死亡，好感度需要重置。
    剧情文本："小D愤怒地说：'我再也不想见到你！'然后离开。"；返回值：1；发生决裂，好感度重置。
    剧情文本："小D昏迷不醒，但还活着。"；返回值：0；没有死亡或决裂。
    剧情文本："小D只是暂时离开去旅行。"；返回值：0；没有情感终结。
}
```

❌  **不好的示例集** ：

```
示例：{
    剧情文本："小D很开心"；返回值：2.0  // 缺少解释原因
    剧情文本："发生了一些事"；返回值：1.0  // 场景描述太模糊
}
```

---

### 3. 占位符支持

在任务说明中可以使用 `{user}` 占位符，系统会自动替换为配置的用户名。

 **示例** ：

```xml
<description>
说明："分析当前剧情，判断小D对{user}的好感度是否有变化"
示例：{
    剧情文本："{user}救了小D一命"；返回值：4.0
}
</description>
```

 **渲染后** （假设 `USER_NAME = "布雷德"`）：

```
说明："分析当前剧情，判断小D对布雷德的好感度是否有变化"
示例：{
    剧情文本："布雷德救了小D一命"；返回值：4.0
}
```

---

## 完整示例

### 示例 1：时间流逝判断（UPDATE）

```xml
<name>
时间变化
</name>

<description>
说明："分析当前剧情中，时间的流逝变化，是否进入新的一天，或过去了若干天，以天为单位"
返回值："返回一个1位小数，范围为0.0到正无穷"
示例：{
    剧情文本："3个小时过去了"；返回值：0.0；没有明显的天数变化
    剧情文本："几个小时过去了"；返回值：0.0；没有明显的天数变化
    剧情文本："1周过去了"；返回值：7.0；1周等于7天
    剧情文本："几个月之后"；返回值：60.0到300.0之间的任意值；从2-10个月均有可能
    剧情文本："次日清晨"；返回值：1.0；进入下一天了
}
</description>
```

---

### 示例 2：体力消耗判断（UPDATE）

```xml
<name>
体力消耗
</name>

<description>
说明："分析当前剧情中，角色是否进行了消耗体力的活动（如战斗、奔跑、劳作等）"
返回值："返回一个1位小数，范围为-10.0到0.0"
示例：{
    剧情文本："{user}与敌人激战了30分钟，汗水湿透了衣服。"；返回值：-5.0；高强度战斗，体力大幅下降。
    剧情文本："{user}在田地里劳作了一整天。"；返回值：-8.0；长时间劳作，体力严重消耗。
    剧情文本："{user}快步走了10分钟。"；返回值：-1.0；轻度运动，体力小幅下降。
    剧情文本："{user}在房间里看书。"；返回值：0.0；静态活动，无体力消耗。
    剧情文本："{user}在生死战中拼尽全力，几乎虚脱。"；返回值：-10.0；极限消耗。
}
</description>
```

---

### 示例 3：关系破裂判断（RESET）

```xml
<name>
友谊重置
</name>

<description>
说明："分析当前剧情，是否出现角色背叛、决裂或永久分离的情节"
返回值："返回0或1，1代表发生关系破裂，需要重置友谊值，0代表关系依然存在。"
示例：{
    剧情文本："角色A向敌人出卖了{user}的位置。"；返回值：1；背叛行为，友谊破裂。
    剧情文本："角色A愤怒地说：'我们从此陌路！'然后扬长而去。"；返回值：1；明确决裂。
    剧情文本："角色A因意外失忆，忘记了与{user}的所有回忆。"；返回值：1；关系从零开始。
    剧情文本："角色A因任务暂时离开一段时间。"；返回值：0；只是暂别，关系依然存在。
    剧情文本："角色A虽然生气，但最终选择了原谅。"；返回值：0；关系受损但未破裂。
}
</description>
```

---

## 进阶技巧

### 1. 使用分层判断

对于复杂的判断任务，可以提供分层的判断标准：

```xml
<description>
说明："分析剧情中角色的情绪强度变化"
返回值："返回一个1位小数，范围为-5.0到5.0"
判断标准：{
    微弱变化（±0.5-1.0）：语气、表情的细微变化
    中度变化（±1.5-2.5）：明显的情绪表达，如笑容、皱眉
    强烈变化（±3.0-4.0）：激烈的情感爆发，如大笑、愤怒
    极端变化（±4.5-5.0）：情感的巨大转折，如绝望、狂喜
}
示例：{
    ...
}
</description>
```

---

### 2. 指定特殊情况处理

明确告诉 LLM 如何处理边界情况：

```xml
<description>
说明："判断角色的受伤程度"
返回值："返回一个1位小数，范围为-10.0到0.0"
特殊情况：{
    - 如果剧情中未明确提及受伤，返回 0.0
    - 如果描述为"轻微擦伤"等，返回 -0.5 到 -1.0
    - 如果描述为"致命伤"，返回 -10.0
}
示例：{
    ...
}
</description>
```

---

### 3. 使用参考锚点

提供清晰的参考标准，帮助 LLM 校准判断：

```xml
<description>
说明："判断食物的美味程度对食欲的影响"
返回值："返回一个1位小数，范围为-3.0到3.0"
参考锚点：{
    3.0：顶级美食，令人食指大动
    1.5：美味佳肴，胃口大开
    0.0：普通食物，无特别感受
    -1.5：难以下咽的食物，食欲下降
    -3.0：令人作呕的食物，完全失去食欲
}
示例：{
    剧情文本："精致的法式大餐摆在面前，香气四溢。"；返回值：2.5；高级美食，食欲显著增强。
    剧情文本："{user}吃了一碗普通的白米饭。"；返回值：0.0；普通食物，无影响。
    剧情文本："发霉的面包散发着恶臭。"；返回值：-2.5；腐坏食物，食欲大减。
}
</description>
```

---

## 常见错误与排查

### 1. 返回值类型错误

❌  **错误** （LLM 返回字符串）：

```xml
<description>
返回值："返回'增加'、'减少'或'不变'"
</description>
```

✓  **正确** （明确数值类型）：

```xml
<description>
返回值："返回一个1位小数，范围为-5.0到5.0，其中正数表示增加，负数表示减少，0.0表示不变"
</description>
```

---

### 2. 示例不足

❌  **错误** （只有 1-2 个示例）：

```xml
示例：{
    剧情文本："小D笑了"；返回值：1.0
}
```

✓  **正确** （至少 3-5 个示例，覆盖多种情况）：

```xml
示例：{
    剧情文本："小D微微一笑"；返回值：0.5；微小的情绪波动
    剧情文本："小D开怀大笑"；返回值：2.5；明显的情绪提升
    剧情文本："小D面无表情"；返回值：0.0；无情绪变化
    剧情文本："小D冷笑一声"；返回值：-1.0；负面情绪
}
```

---

### 3. 范围不明确

❌  **错误** ：

```xml
返回值："返回一个数字，表示变化程度"
```

✓  **正确** ：

```xml
返回值："返回一个1位小数，范围为0.0到10.0"
```

---

### 4. 缺少解释说明

❌  **错误** ：

```xml
示例：{
    剧情文本："小D救了{user}"；返回值：5.0
}
```

✓  **正确** ：

```xml
示例：{
    剧情文本："小D冒着生命危险救了{user}一命"；返回值：5.0；生死相救，情感极大增强
}
```

---


### 1. 文件命名规范

```
update&reset/
├── affection_update.txt        # 好感度更新
├── affection_reset.txt         # 好感度重置
├── time_change_update.txt      # 时间变化
├── stamina_update.txt          # 体力消耗
└── ...
```

### 2. 任务文件组织

* ✅ 一个文件一个任务
* ✅ 文件名清晰表明用途（包含 `update` 或 `reset`）

---

## 附录：完整模板

### UPDATE 任务模板

```xml
<name>
[任务名称]
</name>

<description>
说明："[清晰描述判断目标和规则]"
返回值："返回一个1位小数，范围为[最小值]到[最大值]"
示例：{
    剧情文本："[场景1]"；返回值：[数值1]；[解释1]
    剧情文本："[场景2]"；返回值：[数值2]；[解释2]
    剧情文本："[场景3]"；返回值：[数值3]；[解释3]
    剧情文本："[场景4]"；返回值：[数值4]；[解释4]
    剧情文本："[场景5]"；返回值：[数值5]；[解释5]
}
</description>
```

### RESET 任务模板

```xml
<name>
[任务名称]
</name>

<description>
说明:"[明确触发重置的条件]"
返回值："返回0或1，1代表需要重置，0代表不重置。"
示例：{
    剧情文本："[触发场景1]"；返回值：1；[解释为何触发]
    剧情文本："[触发场景2]"；返回值：1；[解释为何触发]
    剧情文本："[非触发场景1]"；返回值：0；[解释为何不触发]
    剧情文本："[非触发场景2]"；返回值：0；[解释为何不触发]
}
</description>
```
